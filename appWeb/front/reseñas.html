<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reseñas del Hotel</title>
    <style>
        /* Estilos básicos */
        body { font-family: Arial, sans-serif; }
        .review, .review-form {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .no-reviews {
            color: #888;
        }
        .hidden {
            display: none;
        }
        button {
            margin: 10px 0;
        }
    </style>
</head>
<body>

<h1>Reseñas del Hotel <span id="hotel-name"></span></h1>
<button id="review-button">Dejar reseña</button>

<div class="review-form hidden">
    <h2>Escribir una reseña</h2>
    <form id="review-form">
        <input type="text" id="username" placeholder="Nombre de usuario" required /><br>
        <input type="password" id="password" placeholder="Contraseña" required /><br>
        <textarea id="content" placeholder="Contenido de la reseña" required></textarea><br>
        <input type="number" id="rating" placeholder="Calificación (0-5)" required min="0" max="5" /><br>
        <button type="submit">Enviar reseña</button>
    </form>
</div>

<div id="lista-reseñas">
  <!-- Las reseñas se cargarán aquí mediante JavaScript -->
</div>

<script>
function obtenerToken(username, password) {
    return fetch('http://localhost:8080/python-service/token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
    })
    .then(response => {
        if (response.status === 401) {
            throw new Error('Autenticación fallida: usuario o contraseña incorrectos.');
        }
        if (!response.ok) {
            throw new Error('Ocurrió un problema al obtener el token de autenticación.');
        }
        return response.json();
    })
    .then(data => {
        if (!data.access_token) {
            throw new Error('No se recibió token de autenticación del servidor.');
        }
        return data.access_token;
    });
}

function enviarReseña(token, content, rating, hotelId) {
    console.log("Enviando token:", token); // Verifica que el token se muestre correctamente
    
    const headers = new Headers({
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    });

    console.log("Cabeceras:", headers.get('Authorization')); // Verifica que la cabecera de autorización se muestre correctamente

    return fetch('http://localhost:8080/python-service/reviews', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ content, rating, hotel_id: hotelId })
    })
    .then(response => {
        console.log(response); // Verifica la respuesta completa para depurar
        if (response.status === 401) {
            throw new Error('No autorizado: El token de acceso es inválido o ha expirado.');
        }
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.detail || 'No se pudo enviar la reseña. Por favor, intente de nuevo.');
            });
        }
        return response.json();
    });
}

function mostrarReseñas(reseñas) {
    const listaReseñas = document.getElementById('lista-reseñas');
    listaReseñas.innerHTML = ''; // Limpiar la lista anterior

    if (reseñas.length === 0) {
        listaReseñas.innerHTML = '<div class="no-reviews">No hay reseñas para este hotel.</div>';
        return;
    }

    reseñas.forEach(reseña => {
        const reviewElement = document.createElement('div');
        reviewElement.className = 'review';
        reviewElement.innerHTML = `
            <p>Contenido: ${reseña.content}</p>
            <p>Calificación: ${reseña.rating}</p>
            <!-- Aquí iría el código para incluir el nombre de usuario -->
        `;
        listaReseñas.appendChild(reviewElement);
    });
}

function cargarReseñas() {
    const hotelId = new URLSearchParams(window.location.search).get('hotel_id');
    document.getElementById('hotel-name').textContent = `ID: ${hotelId}`;
    fetch(`http://localhost:8080/python-service/reviews/hotel/${encodeURIComponent(hotelId)}`)
    .then(response => response.json())
    .then(mostrarReseñas)
    .catch(error => {
        console.error('Error al cargar reseñas:', error);
    });
}

document.getElementById('review-button').addEventListener('click', function() {
    document.querySelector('.review-form').classList.toggle('hidden');
});

document.getElementById('review-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const content = document.getElementById('content').value;
    const rating = parseInt(document.getElementById('rating').value, 10);
    const hotelId = new URLSearchParams(window.location.search).get('hotel_id');

    obtenerToken(username, password).then(token => {
        if (!token) {
            throw new Error('No se pudo obtener el token de autenticación.');
        }
        return enviarReseña(token, content, rating, hotelId);
    }).then(reseñaCreada => {
        alert('Reseña enviada con éxito.');
        window.location.reload(); // Recargar la página para mostrar la nueva reseña
    }).catch(error => {
        alert(error.message);
    });
});

document.addEventListener('DOMContentLoaded', cargarReseñas);
</script>

</body>
</html>